
> polideportivo-platform@ dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform
> turbo run dev

ÔÇó Packages in scope: @repo/auth, @repo/credit-system, @repo/db, @repo/eslint-config, @repo/notifications, @repo/payments, @repo/typescript-config, @repo/ui, admin, api, docs, web
ÔÇó Running dev in 12 packages
ÔÇó Remote caching disabled
docs:dev: cache bypass, force executing 068005ea95733c5a
web:dev: cache bypass, force executing f1e6c1d6094d81d1
@repo/credit-system:dev: cache bypass, force executing bae72f2e78a0f3c8
api:dev: cache bypass, force executing e381a59ffe4bbe0b
admin:dev: cache bypass, force executing 9e8d2673e60e13c4
admin:dev: 
admin:dev: > admin@0.1.0 dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\apps\admin
admin:dev: > next dev --port 3001
admin:dev: 
api:dev: 
api:dev: > api@0.1.0 dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\apps\api
api:dev: > next dev --port 3002
api:dev: 
@repo/credit-system:dev: 
@repo/credit-system:dev: > @repo/credit-system@1.0.0 dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\packages\credit-system
@repo/credit-system:dev: > tsc --watch
@repo/credit-system:dev: 
web:dev: 
web:dev: > web@0.1.0 dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\apps\web
web:dev: > next dev
web:dev: 
docs:dev: 
docs:dev: > docs@0.1.0 dev C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\apps\docs
docs:dev: > next dev --turbopack --port 3004
docs:dev: 
@repo/credit-system:dev: [2J[3J[H11:02:21 p.┬ám. - Starting compilation in watch mode...
@repo/credit-system:dev: 
docs:dev:  Ô¿» Failed to start server
docs:dev: Error: listen EADDRINUSE: address already in use :::3004
docs:dev:     at <unknown> (Error: listen EADDRINUSE: address already in use :::3004)
docs:dev:     at new Promise (<anonymous>) {
docs:dev:   code: 'EADDRINUSE',
docs:dev:   errno: -4091,
docs:dev:   syscall: 'listen',
docs:dev:   address: '::',
docs:dev:   port: 3004
docs:dev: }
docs:dev: [?25h
api:dev:    Ôû▓ Next.js 15.4.7
api:dev:    - Local:        http://localhost:3002
api:dev:    - Network:      http://192.168.178.12:3002
api:dev:    - Environments: .env.local
api:dev: 
api:dev:  Ô£ô Starting...
admin:dev:    Ôû▓ Next.js 15.4.7
admin:dev:    - Local:        http://localhost:3001
admin:dev:    - Network:      http://192.168.178.12:3001
admin:dev:    - Environments: .env.local
admin:dev:    - Experiments (use with caution):
admin:dev:      ┬À largePageDataBytes: 12800000
admin:dev: 
admin:dev:  Ô£ô Starting...
web:dev:    Ôû▓ Next.js 15.4.7
web:dev:    - Local:        http://localhost:3000
web:dev:    - Network:      http://192.168.178.12:3000
web:dev:    - Environments: .env.local
web:dev:    - Experiments (use with caution):
web:dev:      Ô£ô optimizeCss
web:dev:      ┬À optimizePackageImports
web:dev: 
web:dev:  Ô£ô Starting...
web:dev: ­ƒÜÇ [NEXT-CONFIG] === POLIDEPORTIVO REWRITES CONFIGURATION ===
web:dev: ­ƒöº [NEXT-CONFIG] Backend API URL: http://localhost:3002
web:dev: ­ƒöº [NEXT-CONFIG] Environment: development
web:dev: ­ƒöº [NEXT-CONFIG] Timestamp: 2025-11-21T22:02:22.844Z
web:dev: ­ƒöº [NEXT-CONFIG] Strategy: beforeFiles + negative regex
web:dev:  Ô£ô Ready in 2.8s
admin:dev:  Ô£ô Ready in 2.9s
@repo/credit-system:dev: 
@repo/credit-system:dev: 11:02:25 p.┬ám. - Found 0 errors. Watching for file changes.
api:dev:  Ô£ô Ready in 3.3s
admin:dev:  Ôùï Compiling /_not-found ...
admin:dev:  Ô£ô Compiled /_not-found in 3.5s (758 modules)
admin:dev:  ÔÜá Fast Refresh had to perform a full reload. Read more: https://nextjs.org/docs/messages/fast-refresh-reload
admin:dev:  GET /_next/static/webpack/f58b751206d88c20.webpack.hot-update.json 404 in 4584ms
admin:dev:  Ôùï Compiling /middleware ...
admin:dev:  Ô£ô Compiled /middleware in 1936ms (972 modules)
admin:dev:  ÔÜá Fast Refresh had to perform a full reload. Read more: https://nextjs.org/docs/messages/fast-refresh-reload
admin:dev:  GET /_next/static/webpack/f58b751206d88c20.webpack.hot-update.json 404 in 1321ms
admin:dev:  Ôùï Compiling /reservations/new ...
admin:dev:  Ô£ô Compiled /reservations/new in 677ms (755 modules)
admin:dev:  GET /reservations/new 200 in 1092ms
admin:dev: (node:30520) [DEP0060] DeprecationWarning: The `util._extend` API is deprecated. Please use Object.assign() instead.
admin:dev: (Use `node --trace-deprecation ...` to show where the warning was created)
api:dev:  Ô£ô Compiled /middleware in 427ms (233 modules)
admin:dev:  Ôùï Compiling /api/auth/[...nextauth] ...
admin:dev:  Ô£ô Compiled /api/auth/[...nextauth] in 610ms (908 modules)
api:dev:  Ôùï Compiling /api/admin/payments ...
admin:dev: [NextAuth][warn] debug-enabled
admin:dev:  GET /api/auth/session 200 in 1768ms
api:dev:  Ô£ô Compiled /api/admin/audit in 3.9s (1703 modules)
api:dev: [dotenv@17.2.1] injecting env (0) from .env.local -- tip: ­ƒôí auto-backup env with Radar: https://dotenvx.com/radar
api:dev: --- DEBUGGING DATABASE_URL (FIXED) ---
api:dev: DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres?sslmode=require
api:dev: DIRECT_DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres
api:dev: --- FIN DEBUGGING ---
api:dev: Ô£à [DB] Usando DIRECT_DATABASE_URL para desarrollo
api:dev: ­ƒöù [DB] URL final que se usar├í: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres...
api:dev: ­ƒöù [DB] ┬┐Es Data Proxy?: false
api:dev: ­ƒöù [DB] Longitud de URL: 88
api:dev: ­ƒöù [DB] Primeros 20 caracteres: postgresql://postgre...
api:dev: [Notifications][SMS] Twilio deshabilitado: variables de entorno no v├ílidas o ausentes.
api:dev: ÔÜá´©Å [REDSYS-CONFIG] No se encontr├│ clave configurada, usando clave gen├®rica de test
api:dev: Ô£à [REDSYS-CONFIG] Clave inicializada correctamente: { keyLength: 24, testMode: true, keySource: 'GENERIC_TEST' }
api:dev: [2025-11-21T22:02:38.586Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:38.606Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:38.677Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:38.698Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:38.716Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:38.736Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:38.756Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:38.953Z] GET /api/admin/reservations - 401 (367ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 4928ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:38.964Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:39.092Z] GET /api/admin/orders - 401 (486ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 5060ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:39.095Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:39.210Z] GET /api/admin/users - 401 (533ms)
api:dev:  GET /api/admin/users?limit=100 401 in 5179ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:39.213Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:39.311Z] GET /api/admin/audit - 401 (613ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 3959ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:39.314Z
api:dev: }
admin:dev:  GET /api/auth/session 200 in 25ms
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:39.444Z] GET /api/admin/payments - 401 (728ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 5412ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:02:39.447Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 748,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:39.451Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:39.563Z] GET /api/maintenance - 401 (827ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 5533ms
api:dev:  Ôùï Compiling /api/admin/courts ...
api:dev:  Ô£ô Compiled /api/admin/courts in 1823ms (1710 modules)
api:dev: [dotenv@17.2.1] injecting env (0) from .env.local -- tip: ÔÜÖ´©Å  write to custom object with { processEnv: myObject }
api:dev: --- DEBUGGING DATABASE_URL (FIXED) ---
api:dev: DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres?sslmode=require
api:dev: DIRECT_DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres
api:dev: --- FIN DEBUGGING ---
api:dev: [Notifications][SMS] Twilio deshabilitado: variables de entorno no v├ílidas o ausentes.
api:dev: [2025-11-21T22:02:42.101Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:42.118Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:42.133Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:42.148Z] GET /api/admin/centers - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/centers
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:42.160Z] GET /api/admin/courts - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/courts
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:02:42.171Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.177Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.282Z] GET /api/admin/orders - 401 (181ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 2296ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.286Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.408Z] GET /api/admin/audit - 401 (290ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 2422ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.412Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.521Z] GET /api/notifications - 401 (388ms)
api:dev:  GET /api/notifications?limit=10 401 in 2536ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:02:42.524Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 406,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.528Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.638Z] GET /api/admin/centers - 401 (490ms)
api:dev:  GET /api/admin/centers?page=1&limit=100 401 in 2652ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.641Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.742Z] GET /api/admin/courts - 401 (582ms)
api:dev:  GET /api/admin/courts?includeStats=false&page=1&limit=500 401 in 2755ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:02:42.745Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:02:42.855Z] GET /api/maintenance - 401 (684ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 2867ms
api:dev: [2025-11-21T22:03:03.974Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:03.977Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:04.107Z] GET /api/notifications - 401 (133ms)
api:dev:  GET /api/notifications?limit=10 401 in 162ms
api:dev: [2025-11-21T22:03:06.006Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: ÔÜá´©Å [REDSYS-CONFIG] No se encontr├│ clave configurada, usando clave gen├®rica de test
api:dev: Ô£à [REDSYS-CONFIG] Clave inicializada correctamente: { keyLength: 24, testMode: true, keySource: 'GENERIC_TEST' }
api:dev: [2025-11-21T22:03:06.085Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.086Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.184Z] GET /api/maintenance - 401 (178ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 220ms
api:dev: [2025-11-21T22:03:06.232Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:06.242Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:06.246Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:06.249Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.256Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.394Z] GET /api/admin/reservations - 401 (309ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 430ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.397Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.512Z] GET /api/admin/users - 401 (280ms)
api:dev:  GET /api/admin/users?limit=100 401 in 547ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.514Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.600Z] GET /api/admin/payments - 401 (358ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 636ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.603Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.699Z] GET /api/admin/orders - 401 (453ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 735ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.702Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.806Z] GET /api/admin/audit - 401 (557ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 841ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:03:06.807Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 558,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:03:06.844Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.851Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:06.961Z] GET /api/maintenance - 401 (117ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 148ms
api:dev: [2025-11-21T22:03:06.973Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:06.980Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:07.079Z] GET /api/admin/orders - 401 (106ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 261ms
api:dev: [2025-11-21T22:03:07.090Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:07.092Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:07.196Z] GET /api/admin/audit - 401 (106ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 356ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:03:07.197Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 107,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:03:34.119Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:34.122Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:34.278Z] GET /api/notifications - 401 (159ms)
api:dev:  GET /api/notifications?limit=10 401 in 188ms
api:dev: [2025-11-21T22:03:35.996Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.026Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.134Z] GET /api/maintenance - 401 (138ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 175ms
api:dev: [2025-11-21T22:03:36.139Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:36.142Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:36.145Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:36.149Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:03:36.152Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.156Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.239Z] GET /api/admin/payments - 401 (100ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 279ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.240Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.347Z] GET /api/admin/reservations - 401 (205ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 387ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.348Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.461Z] GET /api/admin/audit - 401 (316ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 499ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.464Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.566Z] GET /api/admin/users - 401 (417ms)
api:dev:  GET /api/admin/users?limit=100 401 in 606ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:03:36.567Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 422,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.569Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.677Z] GET /api/admin/orders - 401 (525ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 718ms
api:dev: [2025-11-21T22:03:36.720Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.727Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.814Z] GET /api/maintenance - 401 (94ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 130ms
api:dev: [2025-11-21T22:03:36.823Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.829Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:36.913Z] GET /api/admin/audit - 401 (90ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 224ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:03:36.915Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 92,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:03:36.925Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:03:36.926Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:03:37.015Z] GET /api/admin/orders - 401 (90ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 300ms
api:dev: [2025-11-21T22:04:03.955Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:03.957Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:04.063Z] GET /api/notifications - 401 (108ms)
api:dev:  GET /api/notifications?limit=10 401 in 127ms
api:dev: [2025-11-21T22:04:05.980Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.014Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.105Z] GET /api/maintenance - 401 (125ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 152ms
api:dev: [2025-11-21T22:04:06.110Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:06.114Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:06.116Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:06.120Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:06.123Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.127Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.235Z] GET /api/admin/reservations - 401 (125ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 282ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.237Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.327Z] GET /api/admin/payments - 401 (213ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 374ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.329Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.460Z] GET /api/admin/users - 401 (344ms)
api:dev:  GET /api/admin/users?limit=100 401 in 508ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.465Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.586Z] GET /api/admin/audit - 401 (466ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 633ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.588Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.684Z] GET /api/admin/orders - 401 (561ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 731ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:04:06.686Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 566,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:04:06.728Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.733Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.812Z] GET /api/maintenance - 401 (84ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 121ms
api:dev: [2025-11-21T22:04:06.817Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.824Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:06.924Z] GET /api/admin/audit - 401 (107ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 227ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:04:06.925Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 108,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:04:06.939Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:06.940Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:07.026Z] GET /api/admin/orders - 401 (87ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 305ms
api:dev: [2025-11-21T22:04:33.953Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:33.954Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:34.041Z] GET /api/notifications - 401 (88ms)
api:dev:  GET /api/notifications?limit=10 401 in 106ms
api:dev: [2025-11-21T22:04:35.969Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:35.999Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.086Z] GET /api/maintenance - 401 (117ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 144ms
api:dev: [2025-11-21T22:04:36.092Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:36.096Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:36.099Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:36.102Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:04:36.105Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.110Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.196Z] GET /api/admin/reservations - 401 (104ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 254ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.198Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.316Z] GET /api/admin/payments - 401 (220ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 373ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.318Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.438Z] GET /api/admin/users - 401 (339ms)
api:dev:  GET /api/admin/users?limit=100 401 in 495ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.440Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.537Z] GET /api/admin/orders - 401 (435ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 593ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.539Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.622Z] GET /api/admin/audit - 401 (517ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 679ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:04:36.623Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 518,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:04:36.661Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.669Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.764Z] GET /api/maintenance - 401 (103ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 134ms
api:dev: [2025-11-21T22:04:36.769Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.776Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.881Z] GET /api/admin/orders - 401 (112ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 249ms
api:dev: [2025-11-21T22:04:36.892Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:04:36.893Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:04:36.968Z] GET /api/admin/audit - 401 (76ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 311ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:04:36.969Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 77,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev:  Ôùï Compiling /api/auth/token ...
api:dev:  Ô£ô Compiled /api/auth/token in 947ms (1711 modules)
api:dev: [dotenv@17.2.1] injecting env (0) from .env.local -- tip: ­ƒöÉ prevent committing .env to code: https://dotenvx.com/precommit
api:dev: --- DEBUGGING DATABASE_URL (FIXED) ---
api:dev: DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres?sslmode=require
api:dev: DIRECT_DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres
api:dev: --- FIN DEBUGGING ---
api:dev: Ô£à [FIREBASE-ADMIN] Inicializado correctamente
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findFirst()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findFirst()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findFirst',
api:dev:   timestamp: 2025-11-21T22:04:41.724Z
api:dev: }
api:dev: ÔØî [AUTH-TOKEN] Error generando JWT: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findFirst()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async postHandler (src\app\api\auth\token\route.ts:100:15)
api:dev:     at async handler (src\lib\api-route-handler.ts:68:25)
api:dev:    98 |     }
api:dev:    99 |
api:dev: > 100 |     let user = await db.user.findFirst({ where: { firebaseUid: decoded.uid } });
api:dev:       |               ^
api:dev:   101 |     if (!user) {
api:dev:   102 |       user = await db.user.findUnique({ where: { email: decoded.email } });
api:dev:   103 |       if (user) { {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev:  POST /api/auth/token 500 in 1913ms
api:dev:  Ôùï Compiling /api/centers ...
api:dev:  Ô£ô Compiled /api/centers in 696ms (1713 modules)
api:dev: [dotenv@17.2.1] injecting env (0) from .env.local -- tip: ÔÜÖ´©Å  enable debug logging with { debug: true }
api:dev: --- DEBUGGING DATABASE_URL (FIXED) ---
api:dev: DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres?sslmode=require
api:dev: DIRECT_DATABASE_URL: postgresql://postgres:***@db.rcknclvzxheitotnhmhn.supabase.co:5432/postgres
api:dev: --- FIN DEBUGGING ---
api:dev: [33m[auth][warn][debug-enabled][0m Read more: https://warnings.authjs.dev
api:dev: [31m[auth][error][0m JWTSessionError: Read more at https://errors.authjs.dev#jwtsessionerror
api:dev: [31m[auth][cause][0m: Error: no matching decryption secret
api:dev:     at clockTolerance (webpack-internal:///(rsc)/../../node_modules/.pnpm/@auth+core@0.40.0_nodemailer@6.10.1/node_modules/@auth/core/jwt.js:91:15)
api:dev:     at async flattenedDecrypt (webpack-internal:///(rsc)/../../node_modules/.pnpm/jose@6.1.0/node_modules/jose/dist/webapi/jwe/flattened/decrypt.js:110:15)
api:dev:     at async compactDecrypt (webpack-internal:///(rsc)/../../node_modules/.pnpm/jose@6.1.0/node_modules/jose/dist/webapi/jwe/compact/decrypt.js:22:23)
api:dev:     at async jwtDecrypt (webpack-internal:///(rsc)/../../node_modules/.pnpm/jose@6.1.0/node_modules/jose/dist/webapi/jwt/decrypt.js:12:23)
api:dev:     at async Object.decode (webpack-internal:///(rsc)/../../node_modules/.pnpm/@auth+core@0.40.0_nodemailer@6.10.1/node_modules/@auth/core/jwt.js:82:25)
api:dev:     at async Module.session (webpack-internal:///(rsc)/../../node_modules/.pnpm/@auth+core@0.40.0_nodemailer@6.10.1/node_modules/@auth/core/lib/actions/session.js:30:29)
api:dev:     at async AuthInternal (webpack-internal:///(rsc)/../../node_modules/.pnpm/@auth+core@0.40.0_nodemailer@6.10.1/node_modules/@auth/core/lib/index.js:51:24)
api:dev:     at async Auth (webpack-internal:///(rsc)/../../node_modules/.pnpm/@auth+core@0.40.0_nodemailer@6.10.1/node_modules/@auth/core/index.js:130:34)
api:dev:     at async GET (webpack-internal:///(rsc)/./src/app/api/centers/route.ts:57:29)
api:dev:     at async AppRouteRouteModule.do (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\compiled\next-server\app-route.runtime.dev.js:5:38782)
api:dev:     at async AppRouteRouteModule.handle (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\compiled\next-server\app-route.runtime.dev.js:5:45984)
api:dev:     at async responseGenerator (webpack-internal:///(rsc)/../../node_modules/.pnpm/next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1/node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fcenters%2Froute&page=%2Fapi%2Fcenters%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcenters%2Froute.ts&appDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi%5Csrc%5Capp&pageExtensions=ts&pageExtensions=tsx&pageExtensions=js&pageExtensions=jsx&rootDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D&isGlobalNotFoundEnabled=!:203:38)
api:dev:     at async AppRouteRouteModule.handleResponse (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\compiled\next-server\app-route.runtime.dev.js:1:183692)
api:dev:     at async handleResponse (webpack-internal:///(rsc)/../../node_modules/.pnpm/next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1/node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fcenters%2Froute&page=%2Fapi%2Fcenters%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcenters%2Froute.ts&appDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi%5Csrc%5Capp&pageExtensions=ts&pageExtensions=tsx&pageExtensions=js&pageExtensions=jsx&rootDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D&isGlobalNotFoundEnabled=!:265:32)
api:dev:     at async handler (webpack-internal:///(rsc)/../../node_modules/.pnpm/next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1/node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fcenters%2Froute&page=%2Fapi%2Fcenters%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fcenters%2Froute.ts&appDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi%5Csrc%5Capp&pageExtensions=ts&pageExtensions=tsx&pageExtensions=js&pageExtensions=jsx&rootDir=C%3A%5CUsers%5CAdmin%5CDesktop%5Cpolideportivo%20oroquieta%5Cpolideportivo-platform%5Capps%5Capi&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D&isGlobalNotFoundEnabled=!:317:13)
api:dev:     at async doRender (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:1592:34)
api:dev:     at async DevServer.renderToResponseWithComponentsImpl (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:1934:13)
api:dev:     at async DevServer.renderPageComponent (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:2400:24)
api:dev:     at async DevServer.renderToResponseImpl (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:2440:32)
api:dev:     at async DevServer.pipeImpl (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:1035:25)
api:dev:     at async NextNodeServer.handleCatchallRenderRequest (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\next-server.js:393:17)
api:dev:     at async DevServer.handleRequestImpl (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\base-server.js:925:17)
api:dev:     at async C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\dev\next-dev-server.js:398:20
api:dev:     at async Span.traceAsyncFn (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\trace\trace.js:157:20)
api:dev:     at async DevServer.handleRequest (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\dev\next-dev-server.js:394:24)
api:dev:     at async invokeRender (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\lib\router-server.js:239:21)
api:dev:     at async handleRequest (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\lib\router-server.js:436:24)
api:dev:     at async requestHandlerImpl (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\lib\router-server.js:464:13)
api:dev:     at async Server.requestListener (C:\Users\Admin\Desktop\polideportivo oroquieta\polideportivo-platform\node_modules\.pnpm\next@15.4.7_@babel+core@7.28.3_@opentelemetry+api@1.9.0_react-dom@19.1.1_react@19.1.1__react@19.1.1\node_modules\next\dist\server\lib\start-server.js:218:13)
api:dev: [31m[auth][details][0m: {}
api:dev:  GET /api/centers?limit=1 401 in 857ms
api:dev: [Notifications][SMS] Twilio deshabilitado: variables de entorno no v├ílidas o ausentes.
api:dev: [2025-11-21T22:05:04.096Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:04.103Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:04.216Z] GET /api/notifications - 401 (120ms)
api:dev:  GET /api/notifications?limit=10 401 in 275ms
api:dev: [2025-11-21T22:05:05.988Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.026Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.132Z] GET /api/maintenance - 401 (144ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 189ms
api:dev: [2025-11-21T22:05:06.149Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: ÔÜá´©Å [REDSYS-CONFIG] No se encontr├│ clave configurada, usando clave gen├®rica de test
api:dev: Ô£à [REDSYS-CONFIG] Clave inicializada correctamente: { keyLength: 24, testMode: true, keySource: 'GENERIC_TEST' }
api:dev: [2025-11-21T22:05:06.233Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:06.245Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:06.257Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:06.271Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.282Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.368Z] GET /api/admin/payments - 401 (219ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 424ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.371Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.460Z] GET /api/admin/reservations - 401 (227ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 515ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.462Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.558Z] GET /api/admin/users - 401 (313ms)
api:dev:  GET /api/admin/users?limit=100 401 in 613ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.560Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.683Z] GET /api/admin/orders - 401 (426ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 740ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.686Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.771Z] GET /api/admin/audit - 401 (500ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 827ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:05:06.774Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 502,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:05:06.820Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.830Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:06.919Z] GET /api/maintenance - 401 (99ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 138ms
api:dev: [2025-11-21T22:05:06.927Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:06.933Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:06.934Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:07.019Z] GET /api/admin/orders - 401 (92ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 233ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:07.022Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:07.097Z] GET /api/admin/audit - 401 (164ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 300ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:05:07.099Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 166,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:05:33.956Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:33.958Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:34.042Z] GET /api/notifications - 401 (86ms)
api:dev:  GET /api/notifications?limit=10 401 in 101ms
api:dev: [2025-11-21T22:05:39.977Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:39.984Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.096Z] GET /api/maintenance - 401 (119ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 149ms
api:dev: [2025-11-21T22:05:40.123Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.148Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.273Z] GET /api/admin/reservations - 401 (150ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 302ms
api:dev: [2025-11-21T22:05:40.278Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:40.282Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:40.285Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:05:40.288Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.293Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.404Z] GET /api/admin/payments - 401 (126ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 431ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.405Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.495Z] GET /api/admin/orders - 401 (213ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 522ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.499Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.622Z] GET /api/admin/users - 401 (337ms)
api:dev:  GET /api/admin/users?limit=100 401 in 650ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.624Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.728Z] GET /api/admin/audit - 401 (440ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 756ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:05:40.729Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 441,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:05:40.757Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.764Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.843Z] GET /api/maintenance - 401 (86ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 112ms
api:dev: [2025-11-21T22:05:40.865Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.872Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:40.950Z] GET /api/admin/orders - 401 (85ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 205ms
api:dev: [2025-11-21T22:05:40.956Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:05:40.957Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:05:41.050Z] GET /api/admin/audit - 401 (94ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 300ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:05:41.052Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 95,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
@repo/credit-system:dev: [2J[3J[H11:06:25 p.┬ám. - File change detected. Starting incremental compilation...
@repo/credit-system:dev: 
@repo/credit-system:dev: 
@repo/credit-system:dev: 11:06:26 p.┬ám. - Found 0 errors. Watching for file changes.
api:dev: [2025-11-21T22:06:39.950Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:06:39.952Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:06:40.048Z] GET /api/notifications - 401 (98ms)
api:dev:  GET /api/notifications?limit=10 401 in 112ms
api:dev: [2025-11-21T22:07:39.972Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:39.983Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.101Z] GET /api/maintenance - 401 (129ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 162ms
api:dev: [2025-11-21T22:07:40.124Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.147Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.241Z] GET /api/admin/reservations - 401 (117ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 273ms
api:dev: [2025-11-21T22:07:40.247Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:07:40.267Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:07:40.270Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:07:40.273Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.286Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.414Z] GET /api/admin/payments - 401 (167ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 446ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.417Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.497Z] GET /api/admin/audit - 401 (230ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 528ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.499Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.587Z] GET /api/admin/orders - 401 (317ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 619ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.588Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.670Z] GET /api/admin/users - 401 (397ms)
api:dev:  GET /api/admin/users?limit=100 401 in 702ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:07:40.672Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 405,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:07:40.684Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.691Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.766Z] GET /api/notifications - 401 (82ms)
api:dev:  GET /api/notifications?limit=10 401 in 492ms
api:dev: [2025-11-21T22:07:40.783Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.787Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.867Z] GET /api/maintenance - 401 (84ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 188ms
api:dev: [2025-11-21T22:07:40.882Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:07:40.884Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.885Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:40.955Z] GET /api/admin/audit - 401 (73ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 181ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:07:40.956Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 74,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:07:40.957Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:07:41.036Z] GET /api/admin/orders - 401 (152ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 262ms
api:dev: [2025-11-21T22:08:39.992Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.021Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.105Z] GET /api/maintenance - 401 (113ms)
api:dev:  GET /api/maintenance?status=SCHEDULED&limit=100 401 in 149ms
api:dev: [2025-11-21T22:08:40.110Z] GET /api/admin/reservations - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/reservations
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:08:40.113Z] GET /api/admin/payments - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/payments
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:08:40.116Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:08:40.119Z] GET /api/admin/users - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/users
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:08:40.122Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.129Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.210Z] GET /api/admin/reservations - 401 (100ms)
api:dev:  GET /api/admin/reservations?status=PENDING&limit=100 401 in 244ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.211Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.298Z] GET /api/admin/payments - 401 (185ms)
api:dev:  GET /api/admin/payments?status=PENDING&limit=100 401 in 332ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.300Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.443Z] GET /api/admin/orders - 401 (327ms)
api:dev:  GET /api/admin/orders?status=PENDING&limit=100 401 in 478ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.445Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.528Z] GET /api/admin/users - 401 (409ms)
api:dev:  GET /api/admin/users?limit=100 401 in 562ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.529Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.605Z] GET /api/admin/audit - 401 (483ms)
api:dev:  GET /api/admin/audit?severity=HIGH&status=ERROR&limit=100 401 in 639ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100","timestamp":"2025-11-21T22:08:40.606Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=HIGH&status=ERROR&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 484,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
api:dev: [2025-11-21T22:08:40.637Z] GET /api/notifications - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/notifications
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.644Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.723Z] GET /api/notifications - 401 (86ms)
api:dev:  GET /api/notifications?limit=10 401 in 113ms
api:dev: [2025-11-21T22:08:40.728Z] GET /api/maintenance - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/maintenance
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: [2025-11-21T22:08:40.731Z] GET /api/admin/orders - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/orders
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.739Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.811Z] GET /api/maintenance - 401 (83ms)
api:dev:  GET /api/maintenance?status=IN_PROGRESS&limit=100 401 in 198ms
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.813Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.889Z] GET /api/admin/orders - 401 (158ms)
api:dev:  GET /api/admin/orders?status=PAID&limit=100 401 in 275ms
api:dev: [2025-11-21T22:08:40.898Z] GET /api/admin/audit - Iniciado
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Iniciando autenticaci├â┬│n h├â┬¡brida
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Origin: null
api:dev: ├░┼©ÔÇØ┬ì [AUTH] Method: GET
api:dev: ├░┼©ÔÇØ┬ì [AUTH] URL: /api/admin/audit
api:dev: ├░┼©ÔÇØÔÇÿ [AUTH] Authorization header: Ausente
api:dev: ├░┼©┬ì┬¬ [AUTH] Intentando autenticaci├â┬│n con NextAuth (getToken)
api:dev: prisma:error 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev: [DB-ERROR] {
api:dev:   message: '\n' +
api:dev:     'Invalid `prisma.user.findUnique()` invocation:\n' +
api:dev:     '\n' +
api:dev:     '\n' +
api:dev:     'Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`',
api:dev:   target: 'user.findUnique',
api:dev:   timestamp: 2025-11-21T22:08:40.899Z
api:dev: }
api:dev: ├ó┬Ø┼Æ [AUTH] Error usando getToken de NextAuth: Error [PrismaClientKnownRequestError]: 
api:dev: Invalid `prisma.user.findUnique()` invocation:
api:dev: 
api:dev: 
api:dev: Error validating datasource `db`: the URL must start with the protocol `prisma://` or `prisma+postgres://`
api:dev:     at async eval (src\lib\middleware\index.ts:239:21)
api:dev:     at async eval (src\lib\middleware\index.ts:481:21)
api:dev:     at async eval (src\lib\middleware\index.ts:535:23)
api:dev:     at async eval (src\lib\middleware\index.ts:429:13)
api:dev:     at async eval (src\lib\middleware\audit.middleware.ts:49:17)
api:dev:   237 |             // 1. Intentar buscar por ID (el m├â┬®todo preferido y m├â┬ís r├â┬ípido).
api:dev:   238 |             if (userId) {
api:dev: > 239 |               user = await db.user.findUnique({ where: { id: userId } });
api:dev:       |                     ^
api:dev:   240 |             }
api:dev:   241 |             
api:dev:   242 |             // 2. Si no se encuentra por ID (o el ID no estaba en el token), {
api:dev:   code: 'P6001',
api:dev:   meta: [Object],
api:dev:   clientVersion: '6.15.0'
api:dev: }
api:dev: ├░┼©┼í┬½ [AUTH] Autenticaci├â┬│n fallida - No se encontr├â┬│ usuario v├â┬ílido
api:dev: [2025-11-21T22:08:40.979Z] GET /api/admin/audit - 401 (81ms)
api:dev:  GET /api/admin/audit?severity=CRITICAL&status=FAILED&limit=100 401 in 347ms
api:dev: AuditService.createAuditLog called with data: {
api:dev:   userId: undefined,
api:dev:   userName: 'Sistema',
api:dev:   userEmail: undefined,
api:dev:   userRole: undefined,
api:dev:   action: 'VIEW_AUDIT_LOGS',
api:dev:   resource: 'audit',
api:dev:   resourceId: 'admin',
api:dev:   entityType: 'admin',
api:dev:   entityId: 'admin',
api:dev:   details: '{"method":"GET","url":"http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100","timestamp":"2025-11-21T22:08:40.980Z"}',
api:dev:   metadata: {
api:dev:     method: 'GET',
api:dev:     url: 'http://localhost:3002/api/admin/audit?severity=CRITICAL&status=FAILED&limit=100',
api:dev:     userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:     referer: 'http://localhost:3001/reservations/new',
api:dev:     origin: null,
api:dev:     responseStatus: 401,
api:dev:     responseHeaders: {
api:dev:       'access-control-allow-credentials': 'true',
api:dev:       'access-control-allow-headers': 'Content-Type, Authorization, Idempotency-Key',
api:dev:       'access-control-allow-methods': 'GET, POST, PUT, DELETE, OPTIONS',
api:dev:       'content-type': 'application/json'
api:dev:     }
api:dev:   },
api:dev:   ipAddress: '::1',
api:dev:   userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36',
api:dev:   sessionId: undefined,
api:dev:   status: 'WARNING',
api:dev:   severity: 'MEDIUM',
api:dev:   category: 'DATA_ACCESS',
api:dev:   tags: [ 'audit', 'logs', 'view' ],
api:dev:   duration: 82,
api:dev:   errorCode: '401',
api:dev:   errorMessage: undefined
api:dev: }
